<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PingPals</title>
  <link rel="stylesheet" href="./chat.css" />
  <link rel="icon" type="image/png" href="./favicon.png"/> 
</head>
<body>
<!-- GIF container -->
<div id="locked">
    <img src="./gifs/67-67-kid.gif">
    <img src="./gifs/67.gif">
    <img src="./gifs/anime-manga.gif">
    <img src="./gifs/chill.gif">
    <img src="./gifs/cute.gif">
    <img src="./gifs/gojo.gif">
    <img src="./gifs/goon-tuah.gif">
    <img src="./gifs/kis.gif">
    <img src="./gifs/shrek.gif">
    <img src="./gifs/what.gif">
    <!-- Right-side GIFs -->
    <img src="./gifs/rightGifs/angry.gif">
    <img src="./gifs/rightGifs/bosnov-67.gif">
    <img src="./gifs/rightGifs/emoji.gif">
    <img src="./gifs/rightGifs/enojado.gif">
    <img src="./gifs/rightGifs/oh-no-oh-my-god.gif">
    <img src="./gifs/rightGifs/patrick-bateman-smile.gif">
    <img src="./gifs/rightGifs/reallycooked.gif">
    <img src="./gifs/rightGifs/sigmasungjinwoo-mewing.gif">
    <img src="./gifs/rightGifs/solo-leveling-sololeveling.gif">
    <img src="./gifs/rightGifs/thofinn.gif">
    <img src="./gifs/rightGifs/thorfinn.gif">
    <img src="./gifs/rightGifs/twitch-twitch-emote.gif">
    <img src="./gifs/rightGifs/what-twitch.gif">
    <!-- New Gen Gif -->
    <img src="./gifs/promo.png">
    <img src="./gifs/promo.png">
    <img src="./gifs/promo.png">
    <img src="./gifs/promo.png">
    <img src="./gifs/promo.png">
    <img src="./gifs/promo.png">
    <img src="./gifs/promo.png">
    <img src="./gifs/promo.png">
    <img src="./gifs/promo.png">
    <img src="./gifs/promo.png">
    <img src="./gifs/promo.png">
</div>

<div class="MainArea">
  <div class="Header2">&nbsp;</div>
  <div class="MainActionContainer">
    <div id="signedInAs" class="GroupNormalMargin"></div>
    <form id="msgForm">
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="msgInput" type="text" placeholder="Type a message" style="flex:1;" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
        <input type="submit" value="Send" />
      </div>
    </form>
    <div id="messages" class="GroupNormalMargin">
      <p>Loading messages...</p>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
/* -------------------- CONFIG -------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBGPFSP0e0oYqKqvJHLB5eGlX9mJ8aU09s",
  authDomain: "test-da143.firebaseapp.com",
  databaseURL: "https://test-da143-default-rtdb.firebaseio.com",
  projectId: "test-da143",
  storageBucket: "test-da143.firebasestorage.app",
  messagingSenderId: "58366480447",
  appId: "1:58366480447:web:f3dd12850f09952b49688a",
  measurementId: "G-T5HK7JTWHW"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* -------------------- USERS -------------------- */
const idToName = {
  "596923": "Muzafar",
  "589533": "Kyle",
  "589425": "Jeffery",
  "564380": "Harshan",
  "603974": "Disani",
  "546766": "Camden",
  "545208": "Braylen",
  "547025": "Jostin",
  "600437": "Blake",
  "599328": "Ethan",
  "592276": "Nitya",
  "598292": "Jacob"
};

const users = {
  "596923": { name: "Muzafar", role: "Admin" },
  "547025": { name: "Jostin", role: "PremiumOG" },
  "599328": { name: "Ethan" },
  "589533": { name: "Kyle" },
  "589425": { name: "Jeffery" },
  "564380": { name: "Harshan" },
  "603974": { name: "Disani" },
  "545208": { name: "Braylen" },
  "600437": { name: "Blake" },
  "598292": { name: "Jacob" }
};

const adminUsers = ["596923"];
const shortCooldownUsers = ["596923", "547025"];

/* -------------------- HELPERS -------------------- */
function getStoredId() {
  return localStorage.getItem('username') || sessionStorage.getItem('username') || null;
}

function escapeHtml(s) {
  if (!s && s !== 0) return '';
  return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;')
                   .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

/* -------------------- CURRENT USER -------------------- */
const currentUserId = getStoredId();
if (!currentUserId) {
  alert("No username found. Please sign in.");
  window.location.href = './index.html';
}
// Apply layout change if not admin
const currentUser = users[currentUserId];
if (!currentUser || currentUser.role !== "Admin") {
  const mainArea = document.querySelector(".MainArea");
  if (mainArea) {
    mainArea.style.marginRight = "20px";
    mainArea.style.width = "70vw";
  }
}

const displayName = idToName[currentUserId] || currentUserId;
document.getElementById('signedInAs').textContent = 'Signed in as: ' + displayName;

/* -------------------- ADMIN PANEL -------------------- */
function createAdminPanel() {
  if (!adminUsers.includes(currentUserId)) return;

  const style = document.createElement("style");
  style.textContent = `
    #adminPanel{position:fixed;top:8px;right:20px;backdrop-filter:brightness(40%);
      border:1px solid #ccc;padding:14px 18px;width:320px;text-align:center;z-index:999;
      animation:fadeIn 0.3s ease;}
    #adminPanel h3{font-size:16px;margin-bottom:10px;}
    #adminPanel button{margin-top:5px;padding:4px 8px;cursor:pointer;}
    #adminPanel input{width:80%;margin:4px 0;padding:3px;}
    #bannedList{max-height:150px;overflow-y:auto;text-align:left;margin-top:8px;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-55%);}to{opacity:1;transform:translateY(-50%);}}
  `;
  document.head.appendChild(style);

  const panel = document.createElement("div");
  panel.id = "adminPanel";
  panel.innerHTML = `
    <h3>Admin Panel</h3>
    <button id="clearMessagesBtn">Clear All Messages</button>
    <p id="adminStatus">Logged in as admin: ${currentUserId}</p>
    <hr>
    <h4>Ban User</h4>
    <input type="text" id="banUsername" placeholder="Enter username or ID" />
    <input type="number" id="banDuration" placeholder="Minutes" min="1"/>
    <button id="banBtn">Ban User</button>
    <p id="banInfo" style="font-size:12px;color:#aaa;margin-top:4px;"></p>
    <hr>
    <h4>Currently Banned Users</h4>
    <div id="bannedList"><p>Loading...</p></div>
  `;
  document.body.appendChild(panel);

  document.getElementById("clearMessagesBtn").addEventListener("click", () => {
    if (confirm("‚ö†Ô∏è Are you sure you want to delete ALL messages?")) {
      db.ref("messages").remove().catch(err => alert("‚ùå Error: " + err.message));
    }
  });

  document.getElementById("banBtn").addEventListener("click", () => {
    const usernameOrId = document.getElementById("banUsername").value.trim();
    const durationMinutes = parseInt(document.getElementById("banDuration").value);
    if (!usernameOrId || isNaN(durationMinutes) || durationMinutes < 1) {
      alert("‚ùå Please enter a valid username/ID and duration.");
      return;
    }
    let userId = Object.keys(idToName).find(id => idToName[id] === usernameOrId) || usernameOrId;
    const banExpires = Date.now() + durationMinutes * 60 * 1000;
    db.ref(`bans/${userId}`).set({ expires: banExpires }).then(() => {
      const expiresDate = new Date(banExpires).toLocaleString();
      alert(`‚úÖ ${usernameOrId} is banned until ${expiresDate}`);
      document.getElementById("banInfo").textContent = `${usernameOrId} banned until ${expiresDate}`;
    }).catch(err => alert("‚ùå Error: " + err.message));
  });

  function updateBannedList() {
    const listDiv = document.getElementById("bannedList");
    db.ref("bans").once("value").then(snap => {
      const bans = snap.val() || {};
      listDiv.innerHTML = "";
      Object.keys(bans).forEach(userId => {
        const ban = bans[userId];
        if (ban.expires && ban.expires > Date.now()) {
          const displayName = idToName[userId] || userId;
          const div = document.createElement("div");
          div.style.display = "flex"; div.style.justifyContent = "space-between"; div.style.alignItems = "center"; div.style.marginBottom = "4px";
          const text = document.createElement("span");
          text.textContent = `${displayName} (expires: ${new Date(ban.expires).toLocaleString()})`;
          const unbanBtn = document.createElement("button");
          unbanBtn.textContent = "Unban";
          unbanBtn.addEventListener("click", () => db.ref(`bans/${userId}`).remove().then(updateBannedList));
          div.appendChild(text); div.appendChild(unbanBtn); listDiv.appendChild(div);
        }
      });
      if (listDiv.innerHTML === "") listDiv.innerHTML = "<p>No active bans.</p>";
    });
  }

  db.ref("bans").on("value", updateBannedList);
  updateBannedList();
}

/* -------------------- BAN CHECK -------------------- */
function checkBan() {
  db.ref(`bans/${currentUserId}`).once("value").then(snap => {
    const banData = snap.val();
    if (banData && banData.expires > Date.now()) {
      alert(`‚õî You have been banned until ${new Date(banData.expires).toLocaleString()}`);
      window.location.href = "./index.html";
    } else if (banData) {
      db.ref(`bans/${currentUserId}`).remove();
    }
  });
}

/* -------------------- ONLINE USERS -------------------- */
const PING_INTERVAL = 1000, OFFLINE_TIMEOUT = 15000;
const userRef = db.ref("presence/" + currentUserId);

function updateStatus(status) {
  userRef.set({ status, lastActive: Date.now() });
}

document.addEventListener("visibilitychange", () => updateStatus(document.hidden ? "away" : "online"));
setInterval(() => updateStatus(document.hidden ? "away" : "online"), PING_INTERVAL);
window.addEventListener("beforeunload", () => updateStatus("offline"));

function createOnlinePanel() {
  const panel = document.createElement("div");
  panel.id = "onlinePanel";
  panel.innerHTML = "<ul id='userList'></ul>";
  // Position based on role
  const currentUserId = localStorage.getItem("username") || sessionStorage.getItem("username");
  const isAdmin = adminUsers.includes(currentUserId);

  panel.style = `
    position: fixed;
    bottom: 4vh;
    left: 20px;
    width: 340px;
    height: 225px;

    border: 1px solid #cccccc;
    bottom: 8.5vh;
    padding: 10px;
    padding-top: 0px;
    font-size: 12px;
    color: white;
    backdrop-filter: brightness(40%);
    z-index: 998;
    overflow-y: auto; /* enables scrolling if too many users */
  `;

  document.body.appendChild(panel);

  const userList = panel.querySelector("#userList");

  db.ref("presence").on("value", snap => {
    const data = snap.val() || {};
    userList.innerHTML = "";
    const now = Date.now();
    const usersArr = [];

    Object.keys(data).forEach(id => {
      const { status, lastActive } = data[id];
      let color = "üî¥";
      if (status === "online") color = "üü¢";
      else if (status === "away") color = "üü°";
      else if (now - lastActive > 15000) color = "üî¥";
      const name = idToName?.[id] || id;
      usersArr.push({ id, name, color });
    });

    // Sort current user on top
    usersArr.sort((a, b) => a.id === currentUserId ? -1 : b.id === currentUserId ? 1 : 0);

    usersArr.forEach(u => {
      const li = document.createElement("li");
      li.innerHTML = u.id === currentUserId ? `<strong>${u.color} ${u.name} (You)</strong>` : `${u.color} ${u.name}`;
      userList.appendChild(li);
    });
  });
}


/* -------------------- MESSAGES -------------------- */
const messagesDiv = document.getElementById('messages');
function renderMessages(data) {
  const val = data || {};
  messagesDiv.innerHTML = '';
  const entries = Object.entries(val).sort((a,b)=>a[1].timestamp - b[1].timestamp);
  if (entries.length===0){ messagesDiv.innerHTML='<p>No messages yet.</p>'; return; }
  for(const [key,msg] of entries){
    const shownName = idToName[msg.username] || msg.username;
    const userInfo = users[msg.username] || {};
    let roleTag = "";
    if(userInfo.role==="Admin") roleTag=`<span style="background:linear-gradient(90deg, red, blue); color:white; padding:2px 6px; border-radius:6px; font-size:11px; margin-right:6px;">Admin</span>`;
    else if(userInfo.role==="PremiumOG") roleTag=`<span style="background:linear-gradient(90deg, #b026ff, #6f00ff); color:white; padding:2px 6px; border-radius:6px; font-size:11px; margin-right:6px;">PremiumOG</span>`;

    const div = document.createElement('div'); div.className='entry';
    if(msg.gifUrl){
      div.innerHTML=`${roleTag}<strong>${escapeHtml(shownName)}:</strong><br>
      <img src="${escapeHtml(msg.gifUrl)}" alt="gif" style="max-width:100%; border-radius:8px;" /><br>
      <small>${new Date(msg.timestamp).toLocaleString()}</small>`;
    }else{
      div.innerHTML=`${roleTag}<strong>${escapeHtml(shownName)}:</strong> ${escapeHtml(msg.text)}
      <br><small>${new Date(msg.timestamp).toLocaleString()}</small>`;
    }
    messagesDiv.appendChild(div);
  }
  messagesDiv.scrollTop=messagesDiv.scrollHeight;
}

/* -------------------- SEND MESSAGE (fixed) -------------------- */
let canSend = true;

const msgForm = document.getElementById('msgForm');
const msgInput = document.getElementById('msgInput');
// support either <button type="submit"> or <input type="submit">
let sendBtn = msgForm.querySelector('button[type="submit"], input[type="submit"]');

// Defensive fallback: if still not found, create a virtual controller object
if (!sendBtn) {
  // create a minimal virtual object so code doesn't throw
  sendBtn = {
    disabled: false,
    style: {},
    setAttribute: () => {},
    removeAttribute: () => {}
  };
}

msgForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const text = msgInput.value.trim();
  if (!text || !canSend) return;

  if (text.length > 100) {
    alert(`‚ö†Ô∏è Message too long! (${text.length}/100 characters)`);
    return;
  }

  // Disable sending + gray out button (works for <button> or <input>)
  canSend = false;
  try {
    sendBtn.disabled = true;
    sendBtn.style.opacity = "0.5";
    sendBtn.style.cursor = "not-allowed";
  } catch (err) {
    // if sendBtn is the virtual fallback, ignore styling errors
  }

    db.ref('messages').push({ username: currentUserId, text, timestamp: Date.now() })
    .then(() => {
      msgInput.value = '';
      setTimeout(() => {
        canSend = true;
        try {
          sendBtn.disabled = false;
          sendBtn.style.opacity = "1";
          sendBtn.style.cursor = "pointer";
        } catch (err) {}
      }, 1500); // cooldown = 1s
    })
    .catch(err => {
      alert(err.message);
      canSend = true;
      try {
        sendBtn.disabled = false;
        sendBtn.style.opacity = "1";
        sendBtn.style.cursor = "pointer";
      } catch (err) {}
    });
});

db.ref('messages').on('value', snap => renderMessages(snap.val()));

/* -------------------- GIF COOLDOWN -------------------- */
const gifStatus = document.createElement("p");
gifStatus.id = "gifStatus";
gifStatus.style = "color:gray;font-size:14px;text-align:center;margin-top:10px;";
gifStatus.textContent = "You can send GIFs freely.";
document.body.appendChild(gifStatus);

function startLocalGifCooldown(seconds) {
  let timeLeft = seconds;
  gifStatus.textContent = `You can send another GIF in ${timeLeft}s`;
  const imgs = document.querySelectorAll("#locked img");
  imgs.forEach(img => {
    img.style.filter = "grayscale(100%)";
    img.style.pointerEvents = "none";
    img.style.opacity = "0.6";
  });

  const timer = setInterval(() => {
    timeLeft--;
    if (timeLeft <= 0) {
      clearInterval(timer);
      imgs.forEach(img => {
        img.style.filter = "none";
        img.style.pointerEvents = "auto";
        img.style.opacity = "1";
      });
      gifStatus.textContent = "You can send GIFs freely.";
    } else {
      gifStatus.textContent = `You can send another GIF in ${timeLeft}s`;
    }
  }, 1000);
}

function enableGifClick(container) {
  const gifs = container.querySelectorAll("img");
  gifs.forEach(img => {
    img.style.cursor = "pointer";

    // üß† Prevent duplicate listeners:
    img.replaceWith(img.cloneNode(true));
  });

  // reselect new clones to attach fresh event listeners
  const newGifs = container.querySelectorAll("img");
  newGifs.forEach(img => {
    img.addEventListener("click", async () => {
      const userId = currentUserId;
      if (!userId) return alert("User not found.");

      const userRef = db.ref(`gifCooldowns/${userId}`);
      const snap = await userRef.once("value");
      const data = snap.val();
      const now = Date.now();
      const cooldownTime = shortCooldownUsers.includes(userId) ? 3000 : 25000;

      if (data && data.expires > now) {
        alert(`‚è≥ Please wait ${Math.ceil((data.expires - now) / 1000)}s before sending another GIF.`);
        return;
      }

      await db.ref("messages").push({
        username: userId,
        gifUrl: img.src,
        timestamp: now
      });

      await userRef.set({ expires: now + cooldownTime });
      setTimeout(() => startLocalGifCooldown(cooldownTime / 1000), 0);
    });
  });
}

// Restore cooldown on page load
async function restoreGifCooldownOnLoad() {
  const userId = currentUserId;
  if (!userId) return;

  const userRef = db.ref(`gifCooldowns/${userId}`);
  const snap = await userRef.once("value");
  const data = snap.val();
  const now = Date.now();

  if (data && data.expires > now) {
    const remaining = Math.ceil((data.expires - now) / 1000);
    startLocalGifCooldown(remaining);
  } else if (data && data.expires <= now) {
    userRef.remove().catch(() => {});
    gifStatus.textContent = "You can send GIFs freely.";
  } else {
    gifStatus.textContent = "You can send GIFs freely.";
  }
}

// Initialize
enableGifClick(document.getElementById("locked"));
restoreGifCooldownOnLoad();

/* -------------------- INIT -------------------- */
window.addEventListener("load", ()=>{
  createAdminPanel();
  checkBan();
  createOnlinePanel();
  enableGifClick(document.getElementById("locked"));
});
</script>
</body>
</html>
