<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PingPals</title>
<link rel="stylesheet" href="./chat.css" />
<link rel="icon" type="image/png" href="./favicon.png"/> 
</head>
<body>

<!-- GIF container -->
<div id="locked">
  <!-- your GIFs -->
  <img src="./gifs/67-67-kid.gif">
  <img src="./gifs/67.gif">
  <img src="./gifs/anime-manga.gif">
  <img src="./gifs/chill.gif">
  <img src="./gifs/cute.gif">
  <img src="./gifs/gojo.gif">
  <img src="./gifs/goon-tuah.gif">
  <img src="./gifs/kis.gif">
  <img src="./gifs/shrek.gif">
  <img src="./gifs/what.gif">
  <img src="./gifs/rightGifs/angry.gif">
  <!-- add the rest of your GIFs here -->
</div>

<div class="MainArea">
  <div class="Header2">&nbsp;</div>
  <div class="MainActionContainer">
    <div id="signedInAs" class="GroupNormalMargin"></div>

    <div id="uploadSection" style="display:none; margin-bottom:10px;">
      <input type="file" id="imageUpload" accept="image/*" />
      <button id="sendImageBtn">Send File</button>
      <div id="imagePreview" style="margin-top:6px;"></div>
    </div>

    <form id="msgForm">
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="msgInput" type="text" placeholder="Type a message" style="flex:1;" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
        <input type="submit" value="Send" />
      </div>
    </form>
    <div id="messages" class="GroupNormalMargin">
      <p>Loading messages...</p>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script type="module">
(async () => {
  // --- FETCH HIDDEN CONFIG & USERS ---
  const configRes = await fetch("/api/config");
  const firebaseConfig = await configRes.json();
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const usersRes = await fetch("/api/users");
  const { users, idToName } = await usersRes.json();

  // --- CURRENT USER ---
  const currentUserId = localStorage.getItem('username') || sessionStorage.getItem('username');
  if (!currentUserId) { alert("No username found."); window.location.href = './index.html'; }
  const currentUser = users[currentUserId] || { role: "Guest" };
  document.getElementById('signedInAs').textContent = 'Signed in as: ' + (idToName[currentUserId] || currentUserId);

  // --- BAN CHECK ---
  const banRef = db.ref(`bans/${currentUserId}`);
  banRef.on("value", snap => {
    const banData = snap.val();
    if (banData && banData.expires > Date.now()) {
      alert(`⛔ You have been banned until ${new Date(banData.expires).toLocaleString()}`);
      window.location.href = "./index.html";
    } else if (banData && banData.expires <= Date.now()) {
      db.ref(`bans/${currentUserId}`).remove();
    }
  });

  // --- SHOW UPLOAD SECTION FOR PREMIUM/ADMIN ---
  const uploadSection = document.getElementById("uploadSection");
  if (["PremiumOG","Admin"].includes(currentUser.role)) {
    uploadSection.style.display = "block";
  }

  // --- IMAGE UPLOAD ---
  const imageInput = document.getElementById("imageUpload");
  const imagePreview = document.getElementById("imagePreview");
  imageInput.addEventListener("change", () => {
    const file = imageInput.files[0];
    if (!file) return;
    if (file.size > 2*1024*1024) { alert("⚠️ Max 2MB!"); imageInput.value=""; imagePreview.innerHTML=""; return; }
    const reader = new FileReader();
    reader.onload = e => { imagePreview.innerHTML = `<img src="${e.target.result}" style="max-width:200px;border-radius:8px;" />`; };
    reader.readAsDataURL(file);
  });

  document.getElementById("sendImageBtn").addEventListener("click", async () => {
    const file = imageInput.files[0];
    if (!file) return alert("Select an image first!");
    const reader = new FileReader();
    reader.onload = async e => {
      const newMsg = { username: currentUserId, gifUrl: e.target.result, timestamp: Date.now() };
      await db.ref("messages").push(newMsg);
      imageInput.value=""; imagePreview.innerHTML="";
    };
    reader.readAsDataURL(file);
  });

  // --- MESSAGES ---
  const messagesDiv = document.getElementById('messages');
  let replyingTo = null;

  function escapeHtml(s){if(!s&&s!==0)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}

  function renderMessages(data){
    const val = data || {};
    messagesDiv.innerHTML = '';
    const entries = Object.entries(val).sort((a,b)=>a[1].timestamp-b[1].timestamp);
    if (!entries.length){ messagesDiv.innerHTML='<p>No messages yet.</p>'; return; }
    for(const [key,msg] of entries){
      const shownName = idToName[msg.username] || msg.username;
      let roleTag = "";
      if(users[msg.username]?.role==="Admin") roleTag=`<span style="background:linear-gradient(90deg, red, blue);color:white;padding:2px 6px;border-radius:6px;font-size:11px;margin-right:6px;">Admin</span>`;
      else if(users[msg.username]?.role==="PremiumOG") roleTag=`<span style="background:linear-gradient(90deg,#b026ff,#6f00ff);color:white;padding:2px 6px;border-radius:6px;font-size:11px;margin-right:6px;">PremiumOG</span>`;
      let div = document.createElement('div');
      div.className='entry'; div.style.marginBottom="10px"; div.dataset.msgId = key;
      const replyHTML = msg.replyTo && val[msg.replyTo] ? `<div style="border-left:3px solid gray;padding-left:6px;font-size:10px;color:#bbb;margin-bottom:4px;">Replied to <strong>${escapeHtml(idToName[val[msg.replyTo].username]||val[msg.replyTo].username)}</strong>: <em>${escapeHtml(val[msg.replyTo].text||"[GIF]")}</em></div>` : '';
      const content = msg.gifUrl ? `${roleTag}<strong>${escapeHtml(shownName)}:</strong><br><img src="${escapeHtml(msg.gifUrl)}" alt="gif" style="max-width:100%;border-radius:8px;" /><br><small>${new Date(msg.timestamp).toLocaleString()}</small>` : `${roleTag}<strong>${escapeHtml(shownName)}:</strong> ${escapeHtml(msg.text)}<br><small>${new Date(msg.timestamp).toLocaleString()}</small>`;
      div.innerHTML = replyHTML + content;
      const replyBtn = document.createElement("button");
      replyBtn.textContent="↻"; replyBtn.style="margin-top:3px;margin-left:1vw;font-size:10px;cursor:pointer;opacity:0.7;border-radius:40px;border:none;color:white;background-color:transparent;";
      replyBtn.addEventListener("click",()=>{ replyingTo=key; });
      div.appendChild(replyBtn);
      messagesDiv.appendChild(div);
    }
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  db.ref('messages').on('value', snap => renderMessages(snap.val()));

  // --- SEND MESSAGE ---
  const msgForm = document.getElementById('msgForm');
  const msgInput = document.getElementById('msgInput');
  msgForm.addEventListener('submit', async e => {
    e.preventDefault();
    const text = msgInput.value.trim();
    if(!text) return;
    if(text.length>100){ alert(`⚠️ Too long (${text.length}/100)`); return; }
    await db.ref('messages').push({ username: currentUserId, text, timestamp: Date.now(), ...(replyingTo?{replyTo:replyingTo}:{}) });
    msgInput.value=''; replyingTo=null;
  });

})();
</script>

</body>
</html>
