<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PingPals</title>
  <link rel="stylesheet" href="./chat.css" />
  <link rel="icon" type="image/png" href="./favicon.png"/> 
</head>
<body>
<!-- GIF container -->
<div id="locked">
    <img src="./gifs/67-67-kid.gif">
    <img src="./gifs/67.gif">
    <img src="./gifs/anime-manga.gif">
    <img src="./gifs/chill.gif">
    <img src="./gifs/cute.gif">
    <img src="./gifs/gojo.gif">
    <img src="./gifs/goon-tuah.gif">
    <img src="./gifs/kis.gif">
    <img src="./gifs/shrek.gif">
    <img src="./gifs/what.gif">
    <!-- Right-side GIFs -->
    <img src="./gifs/rightGifs/angry.gif">
    <img src="./gifs/rightGifs/bosnov-67.gif">
    <img src="./gifs/rightGifs/emoji.gif">
    <img src="./gifs/rightGifs/enojado.gif">
    <img src="./gifs/rightGifs/oh-no-oh-my-god.gif">
    <img src="./gifs/rightGifs/patrick-bateman-smile.gif">
    <img src="./gifs/rightGifs/reallycooked.gif">
    <img src="./gifs/rightGifs/sigmasungjinwoo-mewing.gif">
    <img src="./gifs/rightGifs/solo-leveling-sololeveling.gif">
    <img src="./gifs/rightGifs/thofinn.gif">
    <img src="./gifs/rightGifs/thorfinn.gif">
    <img src="./gifs/rightGifs/twitch-twitch-emote.gif">
    <img src="./gifs/rightGifs/what-twitch.gif">
    <!-- New Gen Gif -->
    <img src="./gifs/promo.png">
    <img src="./gifs/promo.png">
    <img src="./gifs/promo.png">
    <img src="./gifs/promo.png">
    <img src="./gifs/promo.png">
    <img src="./gifs/promo.png">
    <img src="./gifs/promo.png">
    <img src="./gifs/promo.png">
    <img src="./gifs/promo.png">
    <img src="./gifs/promo.png">
    <img src="./gifs/promo.png">
</div>

<div class="MainArea">
  <div class="Header2">&nbsp;</div>
  <div class="MainActionContainer">
    <div id="signedInAs" class="GroupNormalMargin"></div>
    <div id="uploadSection" style="display:none; margin-bottom:10px;">
    <input type="file" id="imageUpload" accept="image/*" />
    <button id="sendImageBtn">Send File</button>
      <div id="imagePreview" style="margin-top:6px;"></div>
  </div>

    <form id="msgForm">
      <div style="display:flex; gap:8px; align-items:center;">
        <input id="msgInput" type="text" placeholder="Type a message" style="flex:1;" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
        <input type="submit" value="Send" />
      </div>
    </form>
    <div id="messages" class="GroupNormalMargin">
      <p>Loading messages...</p>
    </div>
  </div>
</div>

<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
/* -------------------- CONFIG -------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyBGPFSP0e0oYqKqvJHLB5eGlX9mJ8aU09s",
  authDomain: "test-da143.firebaseapp.com",
  databaseURL: "https://test-da143-default-rtdb.firebaseio.com",
  projectId: "test-da143",
  storageBucket: "test-da143.firebasestorage.app",
  messagingSenderId: "58366480447",
  appId: "1:58366480447:web:f3dd12850f09952b49688a",
  measurementId: "G-T5HK7JTWHW"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* -------------------- USERS -------------------- */
const idToName = {
  "596923": "Muzafar",
  "589533": "Kyle",
  "589425": "Jeffery",
  "564380": "Harshan",
  "603974": "Disani",
  "546766": "Camden",
  "545208": "Braylen",
  "547025": "Jostin",
  "600437": "Blake",
  "599328": "Ethan",
  "592276": "Nitya",
  "598292": "Jacob"
};

const users = {
  "596923": { name: "Muzafar", role: "Admin" },
  "547025": { name: "Jostin", role: "PremiumOG" },
  "599328": { name: "Ethan" },
  "589533": { name: "Kyle" },
  "589425": { name: "Jeffery" },
  "564380": { name: "Harshan" },
  "603974": { name: "Disani" },
  "545208": { name: "Braylen" },
  "600437": { name: "Blake" },
  "598292": { name: "Jacob" }
};

const adminUsers = ["596923"];
const shortCooldownUsers = ["596923", "547025"];

/* -------------------- HELPERS -------------------- */
function getStoredId() {
  return localStorage.getItem('username') || sessionStorage.getItem('username') || null;
}

function escapeHtml(s) {
  if (!s && s !== 0) return '';
  return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;')
                   .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

/* -------------------- CURRENT USER -------------------- */
const currentUserId = getStoredId();
if (!currentUserId) {
  alert("No username found. Please sign in.");
  window.location.href = './index.html';
}
// Apply layout change if not admin
const currentUser = users[currentUserId];
if (!currentUser || currentUser.role !== "Admin") {
  const mainArea = document.querySelector(".MainArea");
  if (mainArea) {
    mainArea.style.marginRight = "20px";
    mainArea.style.width = "70vw";
  }
}

const displayName = idToName[currentUserId] || currentUserId;
document.getElementById('signedInAs').textContent = 'Signed in as: ' + displayName;

/* -------------------- ADMIN PANEL -------------------- */
function createAdminPanel() {
  if (!adminUsers.includes(currentUserId)) return;

  const style = document.createElement("style");
  style.textContent = `
    #adminPanel{position:fixed;top:8px;right:20px;backdrop-filter:brightness(40%);
      border:1px solid #ccc;padding:14px 18px;width:320px;height:85vh;text-align:center;z-index:999;
      animation:fadeIn 0.3s ease;}
    #adminPanel h3{font-size:16px;margin-bottom:10px;}
    #adminPanel button{margin-top:5px;padding:4px 8px;cursor:pointer;}
    #adminPanel input{width:80%;margin:4px 0;padding:3px;}
    #bannedList{max-height:150px;overflow-y:auto;text-align:left;margin-top:8px;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(-55%);}to{opacity:1;transform:translateY(-50%);}}
  `;
  document.head.appendChild(style);

  const panel = document.createElement("div");
  panel.id = "adminPanel";
  panel.innerHTML = `
    <h3>Admin Panel</h3>
    <button id="clearMessagesBtn">Clear All Messages</button>
    <p id="adminStatus">Logged in as admin: ${currentUserId}</p>
    <hr>
    <h4>Ban User</h4>
    <input type="text" id="banUsername" placeholder="Enter username or ID" />
    <input type="number" id="banDuration" placeholder="Minutes" min="1"/>
    <button id="banBtn">Ban User</button>
    <p id="banInfo" style="font-size:12px;color:#aaa;margin-top:4px;"></p>
    <hr>
    <h4>Currently Banned Users</h4>
    <div id="bannedList"><p>Loading...</p></div>
  `;
  document.body.appendChild(panel);

  document.getElementById("clearMessagesBtn").addEventListener("click", () => {
    if (confirm("‚ö†Ô∏è Are you sure you want to delete ALL messages?")) {
      db.ref("messages").remove().catch(err => alert("‚ùå Error: " + err.message));
    }
  });

  document.getElementById("banBtn").addEventListener("click", () => {
    const usernameOrId = document.getElementById("banUsername").value.trim();
    const durationMinutes = parseInt(document.getElementById("banDuration").value);
    if (!usernameOrId || isNaN(durationMinutes) || durationMinutes < 1) {
      alert("‚ùå Please enter a valid username/ID and duration.");
      return;
    }
    let userId = Object.keys(idToName).find(id => idToName[id] === usernameOrId) || usernameOrId;
    const banExpires = Date.now() + durationMinutes * 60 * 1000;
    db.ref(`bans/${userId}`).set({ expires: banExpires }).then(() => {
      const expiresDate = new Date(banExpires).toLocaleString();
      alert(`‚úÖ ${usernameOrId} is banned until ${expiresDate}`);
      document.getElementById("banInfo").textContent = `${usernameOrId} banned until ${expiresDate}`;
    }).catch(err => alert("‚ùå Error: " + err.message));
  });

  function updateBannedList() {
    const listDiv = document.getElementById("bannedList");
    db.ref("bans").once("value").then(snap => {
      const bans = snap.val() || {};
      listDiv.innerHTML = "";
      Object.keys(bans).forEach(userId => {
        const ban = bans[userId];
        if (ban.expires && ban.expires > Date.now()) {
          const displayName = idToName[userId] || userId;
          const div = document.createElement("div");
          div.style.display = "flex"; div.style.justifyContent = "space-between"; div.style.alignItems = "center"; div.style.marginBottom = "4px";
          const text = document.createElement("span");
          text.textContent = `${displayName} (expires: ${new Date(ban.expires).toLocaleString()})`;
          const unbanBtn = document.createElement("button");
          unbanBtn.textContent = "Unban";
          unbanBtn.addEventListener("click", () => db.ref(`bans/${userId}`).remove().then(updateBannedList));
          div.appendChild(text); div.appendChild(unbanBtn); listDiv.appendChild(div);
        }
      });
      if (listDiv.innerHTML === "") listDiv.innerHTML = "<p>No active bans.</p>";
    });
  }

  db.ref("bans").on("value", updateBannedList);
  updateBannedList();
}

/* -------------------- BAN CHECK -------------------- */
function checkBan() {
  db.ref(`bans/${currentUserId}`).once("value").then(snap => {
    const banData = snap.val();
    if (banData && banData.expires > Date.now()) {
      alert(`‚õî You have been banned until ${new Date(banData.expires).toLocaleString()}`);
      window.location.href = "./index.html";
    } else if (banData) {
      db.ref(`bans/${currentUserId}`).remove();
    }
  });
}




/* -------------------- ONLINE USERS FIXED -------------------- */
const PING_INTERVAL = 1000; // heartbeat every 1s
const userRef = db.ref("presence/" + currentUserId);

// unique ID for this tab
const tabId = Date.now() + "-" + Math.floor(Math.random() * 1000);

// Update this tab's presence
function updateStatus() {
  userRef.child(tabId).set({
    lastActive: Date.now(),
    visible: !document.hidden // true = tab is visible, false = tab in background
  });
}

// Remove this tab from presence when closed
function clearTab() {
  userRef.child(tabId).remove();
}

// Heartbeat ping
setInterval(updateStatus, PING_INTERVAL);
window.addEventListener("beforeunload", clearTab);
document.addEventListener("visibilitychange", updateStatus);

// Online panel
function createOnlinePanel() {
  const panel = document.createElement("div");
  panel.id = "onlinePanel";
  panel.innerHTML = "<ul id='userList'></ul>";
  panel.style = `
    position: fixed;
    bottom: 8.5vh;
    left: 20px;
    width: 340px;
    height: 225px;
    border: 1px solid #ccc;
    padding: 10px;
    font-size: 12px;
    color: white;
    backdrop-filter: brightness(40%);
    z-index: 998;
    overflow-y: auto;
  `;
  document.body.appendChild(panel);

  const userList = panel.querySelector("#userList");

  db.ref("presence").on("value", snap => {
    const data = snap.val() || {};
    userList.innerHTML = "";

    Object.keys(data).forEach(userId => {
      const tabs = Object.values(data[userId] || {});
      let color = "üî¥"; // default red = no tabs open
      if (tabs.length > 0) {
        color = tabs.some(t => t.visible) ? "üü¢" : "üü°";
      }
      const name = idToName[userId] || userId;
      const li = document.createElement("li");
      li.innerHTML = userId === currentUserId
        ? `<strong>${color} ${name} (You)</strong>`
        : `${color} ${name}`;
      userList.appendChild(li);
    });
  });
}

createOnlinePanel();
updateStatus();



/* -------------------- MESSAGES with Replies -------------------- */
const messagesDiv = document.getElementById('messages');
let replyingTo = null; // track which message is being replied to

function renderMessages(data) {
  const val = data || {};
  messagesDiv.innerHTML = '';
  const entries = Object.entries(val).sort((a,b)=>a[1].timestamp - b[1].timestamp);
  if (entries.length === 0) {
    messagesDiv.innerHTML = '<p>No messages yet.</p>';
    return;
  }

  for (const [key, msg] of entries) {
    const shownName = idToName[msg.username] || msg.username;
    const userInfo = users[msg.username] || {};
    let roleTag = "";
    if (userInfo.role === "Admin")
      roleTag = `<span style="background:linear-gradient(90deg, red, blue); color:white; padding:2px 6px; border-radius:6px; font-size:11px; margin-right:6px;">Admin</span>`;
    else if (userInfo.role === "PremiumOG")
      roleTag = `<span style="background:linear-gradient(90deg, #b026ff, #6f00ff); color:white; padding:2px 6px; border-radius:6px; font-size:11px; margin-right:6px;">PremiumOG</span>`;

    // Base message wrapper
    const div = document.createElement('div');
    div.className = 'entry';
    div.style.marginBottom = "10px";
    div.dataset.msgId = key;

    // If this message is a reply
    let replyHTML = "";
    if (msg.replyTo && val[msg.replyTo]) {
      const repliedMsg = val[msg.replyTo];
      const repliedName = idToName[repliedMsg.username] || repliedMsg.username;
      replyHTML = `
        <div style="border-left: 3px solid gray; padding-left: 6px; font-size:10px; color:#bbb; margin-bottom:4px;">
          Replied to <strong>${escapeHtml(repliedName)}</strong>: 
          <em>${escapeHtml(repliedMsg.text || "[GIF]")}</em>
        </div>
      `;
    }

    const content = msg.gifUrl
      ? `${roleTag}<strong>${escapeHtml(shownName)}:</strong><br>
         <img src="${escapeHtml(msg.gifUrl)}" alt="gif" style="max-width:100%; border-radius:8px;" /><br>
         <small>${new Date(msg.timestamp).toLocaleString()}</small>`
      : `${roleTag}<strong>${escapeHtml(shownName)}:</strong> ${escapeHtml(msg.text)}<br>
         <small>${new Date(msg.timestamp).toLocaleString()}</small>`;

    div.innerHTML = replyHTML + content;

    // Add reply button (text)
    const replyBtn = document.createElement("button");
    replyBtn.textContent = "‚Üª";
    replyBtn.style = "margin-top:3px; margin-left: 1vw; font-size:10px; cursor:pointer; opacity:0.7; border-radius:40px; border:none; color:white; background-color:transparent;";
    replyBtn.addEventListener("click", () => setReplyTarget(key, shownName, msg.text));

    div.appendChild(replyBtn);
    messagesDiv.appendChild(div);
  }

  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

/* --- Reply target logic --- */
function setReplyTarget(messageId, name, text) {
  replyingTo = messageId;
  const preview = document.getElementById("replyPreview");
  preview.innerHTML = `Replying to <strong>${escapeHtml(name)}</strong>: <em>${escapeHtml(text || "[GIF]")}</em> 
    <button id="cancelReply" style="margin-left:10px; cursor:pointer; font-size:10px; border-radius:40px; border:none; color:white; background-color:transparent;">x</button>`;
  preview.style.display = "block";

  document.getElementById("cancelReply").onclick = () => {
    replyingTo = null;
    preview.style.display = "none";
  };
}

/* --- Add a reply preview area above the input --- */
const replyPreview = document.createElement("div");
replyPreview.id = "replyPreview";
replyPreview.style = `
  display:none;
  height: 0px;
  background:rgba(255,255,255,0.08);
  padding-bottom:12px;
  border-radius:6px;
  margin:8px 0;
  font-size:10px;
`;
document.querySelector("form#msgForm").before(replyPreview);

/* --- Send message --- */
let canSend = true;
const msgForm = document.getElementById('msgForm');
const msgInput = document.getElementById('msgInput');
let sendBtn = msgForm.querySelector('button[type="submit"], input[type="submit"]');
if (!sendBtn) sendBtn = { disabled: false, style: {}, setAttribute:()=>{}, removeAttribute:()=>{} };

msgForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const text = msgInput.value.trim();
  if (!text || !canSend) return;

  if (text.length > 100) {
    alert(`‚ö†Ô∏è Message too long! (${text.length}/100 characters)`);
    return;
  }

  canSend = false;
  sendBtn.disabled = true;
  sendBtn.style.opacity = "0.5";
  sendBtn.style.cursor = "not-allowed";

  const newMsg = {
    username: currentUserId,
    text,
    timestamp: Date.now()
  };
  if (replyingTo) newMsg.replyTo = replyingTo;

  db.ref('messages').push(newMsg)
    .then(() => {
      msgInput.value = '';
      replyingTo = null;
      replyPreview.style.display = "none";
      setTimeout(() => {
        canSend = true;
        sendBtn.disabled = false;
        sendBtn.style.opacity = "1";
        sendBtn.style.cursor = "pointer";
      }, 1500);
    })
    .catch(err => {
      alert(err.message);
      canSend = true;
      sendBtn.disabled = false;
      sendBtn.style.opacity = "1";
      sendBtn.style.cursor = "pointer";
    });
});

db.ref('messages').on('value', snap => renderMessages(snap.val()));

/* -------------------- GIF COOLDOWN -------------------- */
const gifStatus = document.createElement("p");
gifStatus.id = "gifStatus";
gifStatus.style = "color:gray;font-size:14px;text-align:center;margin-top:10px;";
gifStatus.textContent = "You can send GIFs freely.";
document.body.appendChild(gifStatus);

function startLocalGifCooldown(seconds) {
  let timeLeft = seconds;
  gifStatus.textContent = `You can send another GIF in ${timeLeft}s`;
  const imgs = document.querySelectorAll("#locked img");
  imgs.forEach(img => {
    img.style.filter = "grayscale(100%)";
    img.style.pointerEvents = "none";
    img.style.opacity = "0.6";
  });

  const timer = setInterval(() => {
    timeLeft--;
    if (timeLeft <= 0) {
      clearInterval(timer);
      imgs.forEach(img => {
        img.style.filter = "none";
        img.style.pointerEvents = "auto";
        img.style.opacity = "1";
      });
      gifStatus.textContent = "You can send GIFs freely.";
    } else {
      gifStatus.textContent = `You can send another GIF in ${timeLeft}s`;
    }
  }, 1000);
}

function enableGifClick(container) {
  const gifs = container.querySelectorAll("img");
  gifs.forEach(img => {
    img.style.cursor = "pointer";

    // Remove any old event listeners
    img.replaceWith(img.cloneNode(true));
  });

  const newGifs = container.querySelectorAll("img");

  newGifs.forEach(img => {
    let localBlocked = false; // local cooldown flag

    img.addEventListener("click", async () => {
      if (localBlocked) return; // already in local cooldown

      const userId = currentUserId;
      if (!userId) return alert("User not found.");

      const cooldownTime = shortCooldownUsers.includes(userId) ? 3000 : 25000;

      // Immediately block locally
      localBlocked = true;
      startLocalGifCooldown(cooldownTime / 1000);

      // Check server-side cooldown
      const userRef = db.ref(`gifCooldowns/${userId}`);
      try {
        const snap = await userRef.once("value");
        const data = snap.val();
        const now = Date.now();

        if (data && data.expires > now) {
          const wait = Math.ceil((data.expires - now) / 1000);
          alert(`‚è≥ Please wait ${wait}s before sending another GIF.`);
          localBlocked = false; // allow retry after alert
          return;
        }

        // Send GIF
        await db.ref("messages").push({
          username: userId,
          gifUrl: img.src,
          timestamp: now
        });

        // Set server cooldown
        await userRef.set({ expires: now + cooldownTime });

      } catch (err) {
        alert("‚ùå Error sending GIF: " + err.message);
        localBlocked = false; // reset flag on error
      }
    });
  });
}

// Restore cooldown on page load
async function restoreGifCooldownOnLoad() {
  const userId = currentUserId;
  if (!userId) return;

  const userRef = db.ref(`gifCooldowns/${userId}`);
  const snap = await userRef.once("value");
  const data = snap.val();
  const now = Date.now();

  if (data && data.expires > now) {
    const remaining = Math.ceil((data.expires - now) / 1000);
    startLocalGifCooldown(remaining);
  } else if (data && data.expires <= now) {
    userRef.remove().catch(() => {});
    gifStatus.textContent = "You can send GIFs freely.";
  } else {
    gifStatus.textContent = "You can send GIFs freely.";
  }
}

// Initialize
enableGifClick(document.getElementById("locked"));
restoreGifCooldownOnLoad();

/* -------------------- INIT -------------------- */
window.addEventListener("load", ()=>{
  createAdminPanel();
  checkBan();
  createOnlinePanel();
  enableGifClick(document.getElementById("locked"));
});
</script>
<!-- -------------------- IMAGE UPLOAD -------------------- -->
<script>
// Show upload section only to PremiumOG/Admin
const uploadSection = document.getElementById("uploadSection");
if (currentUser.role === "PremiumOG" || currentUser.role === "Admin") {
  uploadSection.style.display = "block";
}

const imageInput = document.getElementById("imageUpload");
const imagePreview = document.getElementById("imagePreview");

// Preview selected image
imageInput.addEventListener("change", () => {
  const file = imageInput.files[0];
  if (!file) return;
  if (file.size > 2 * 1024 * 1024) { // 2MB max
    alert("‚ö†Ô∏è File too large! Max 2MB.");
    imageInput.value = "";
    imagePreview.innerHTML = "";
    return;
  }
  const reader = new FileReader();
  reader.onload = e => {
    imagePreview.innerHTML = `<img src="${e.target.result}" style="max-width:200px; border-radius:8px;" />`;
  };
  reader.readAsDataURL(file);
});

// Upload image to Firebase as a message
document.getElementById("sendImageBtn").addEventListener("click", async () => {
  const file = imageInput.files[0];
  if (!file) return alert("Select an image first!");

  const reader = new FileReader();
  reader.onload = async e => {
    const imageData = e.target.result;
    try {
      const newMsg = {
        username: currentUserId,
        gifUrl: imageData, // reuse gifUrl field
        timestamp: Date.now()
      };
      db.ref("messages").push(newMsg);
      // Reset input
      imageInput.value = "";
      imagePreview.innerHTML = "";
    } catch (err) {
      alert("‚ùå Upload failed: " + err.message);
    }
  };
  reader.readAsDataURL(file);
});
</script>
</body>
</html>
