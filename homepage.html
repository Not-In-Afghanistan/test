<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PingPals</title>
  <link rel="stylesheet" href="./chat.css" />
  <link rel="icon" type="image/png" href="./LOGO.png"/> 
</head>






<body>
<script>
  // Redirect if not logged in properly
  if (sessionStorage.getItem("loginAsk") !== "true") {
    // Optional: alert before redirect
    alert("Access denied. Redirecting to login...");
    window.location.href = "./index.html";
  }
</script>

<input type="submit" id="toggleBtn" value="Hide GIFs">
<div id="locked">
    <img src="./gifs/67-67-kid.gif">
    <img src="./gifs/67.gif">
    <img src="./gifs/anime-mad.gif">
    <img src="./gifs/anime-manga.gif">
    <img src="./gifs/chill.gif">
    <img src="./gifs/cute.gif">
    <img src="./gifs/gojo.gif">
    <img src="./gifs/goon-tuah.gif">
    <img src="./gifs/kakashi.gif">
    <img src="./gifs/kis.gif">
    <img src="./gifs/mad.gif">
    <img src="./gifs/mango-mango-mango.gif">
    <img src="./gifs/mommy-anime.gif">
    <img src="./gifs/shrek.gif">
    <img src="./gifs/dancing-parrott.gif">
    <!-- Right-side GIFs -->
    <img src="./gifs/rightGifs/7tv-emotes.gif">
    <img src="./gifs/rightGifs/angry.gif">
    <img src="./gifs/rightGifs/black-guy-maid-vibe-black-maid-dance.gif">
    <img src="./gifs/rightGifs/bosnov-67.gif">
    <img src="./gifs/rightGifs/emoji.gif">
    <img src="./gifs/rightGifs/enojado.gif">
    <img src="./gifs/rightGifs/gooner-goon.gif">
    <img src="./gifs/rightGifs/hasbulla-hasbik.gif">
    <img src="./gifs/rightGifs/kermit-the-frog.gif">
    <img src="./gifs/rightGifs/oh-no-oh-my-god.gif">
    <img src="./gifs/rightGifs/patrick-bateman-smile.gif">
    <img src="./gifs/rightGifs/reallycooked.gif">
    <img src="./gifs/rightGifs/sigmasungjinwoo-mewing.gif">
    <img src="./gifs/rightGifs/solid-snake-salute.gif">
    <img src="./gifs/rightGifs/solo-leveling-sololeveling.gif">
    <img src="./gifs/rightGifs/thofinn.gif">
    <img src="./gifs/rightGifs/thorfinn.gif">
    <img src="./gifs/rightGifs/twitch-twitch-emote.gif">
    <img src="./gifs/rightGifs/vinland-saga-thorfinn.gif">
    <img src="./gifs/rightGifs/what-twitch.gif">
</div>

</div>
  <div class="MainArea">

    <div class="Header2"><img src="./newlog.png"></div>
    <div class="MainActionContainer">
       <!-- Username is taken from sessionStorage set on sign-in -->

       <div id="signedInAs" class="GroupNormalMargin"></div>

         <form id="msgForm">
          <div style="display:flex; gap:8px; align-items:center;">
             <input id="msgInput" type="text" placeholder="Type a message" style="flex:1;" />
             <input type="submit" value="Send" />
          </div>
         </form>

       <div id="messages" class="GroupNormalMargin">
         <p>Loading messages...</p>
       </div>
    </div>

  </div>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

<script>
  // Firebase config (same as other pages)
  const firebaseConfig = {
    apiKey: "AIzaSyBGPFSP0e0oYqKqvJHLB5eGlX9mJ8aU09s",
    authDomain: "test-da143.firebaseapp.com",
    databaseURL: "https://test-da143-default-rtdb.firebaseio.com",
    projectId: "test-da143",
    storageBucket: "test-da143.firebasestorage.app",
    messagingSenderId: "58366480447",
    appId: "1:58366480447:web:f3dd12850f09952b49688a",
    measurementId: "G-T5HK7JTWHW"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // ðŸ”¹ Map of 6-digit IDs to display names
  const idToName = {
    "596923": "Muzafar",
    "589533": "Kyle",
    "589425": "Jeffery",
    "564380": "Harshan",
    "603974": "Disani",
    "546766": "Camden",
    "596922": "Veena",
    "598292": "Jacob"
    // Add more like: "123456": "YourChosenName"
  };

  const msgForm = document.getElementById('msgForm');
  const msgInput = document.getElementById('msgInput');
  const messagesDiv = document.getElementById('messages');

  // Helper to get stored ID
  function getStoredId() {
    return localStorage.getItem('username') || sessionStorage.getItem('username') || null;
  }

  // Get user ID and convert to display name
  const currentUserId = getStoredId();
  if (!currentUserId) {
    alert('No username found. Please sign in.');
    window.location.href = './index.html';
  }

  const displayName = idToName[currentUserId] || currentUserId;
  const signedInEl = document.getElementById('signedInAs');
  if (signedInEl) signedInEl.textContent = 'Signed in as: ' + displayName;

  // ðŸ”¹ Render messages (translate IDs to names)
  function renderMessages(data) {
    const val = data || {};
    messagesDiv.innerHTML = '';
    const entries = Object.entries(val).sort((a, b) => a[1].timestamp - b[1].timestamp);
    if (entries.length === 0) {
      messagesDiv.innerHTML = '<p>No messages yet.</p>';
      return;
    }
    for (const [key, msg] of entries) {
      const shownName = idToName[msg.username] || msg.username;
      const div = document.createElement('div');
      div.className = 'entry';
      if (msg.gifUrl) {
        div.innerHTML = `
          <strong>${escapeHtml(shownName)}:</strong><br>
          <img src="${escapeHtml(msg.gifUrl)}" alt="gif" style="max-width:100%; border-radius:8px;" />
          <br><small>${new Date(msg.timestamp).toLocaleString()}</small>`;
      } else {
        div.innerHTML = `
          <strong>${escapeHtml(shownName)}:</strong> ${escapeHtml(msg.text)} 
          <br><small>${new Date(msg.timestamp).toLocaleString()}</small>`;
      }
      messagesDiv.appendChild(div);
    }
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

// ðŸ”¹ GIF click to send
function enableGifClick(container) {
  container.querySelectorAll("img").forEach(img => {
    img.addEventListener("click", () => {
      const gifUrl = img.src;
      db.ref('messages').push({
        username: currentUserId,
        gifUrl: gifUrl,
        timestamp: Date.now()
      }).catch(err => alert(err.message));
    });
  });
}
enableGifClick(document.getElementById("locked"));



// ðŸ”¹ Escape HTML helper
  function escapeHtml(s) {
    if (!s && s !== 0) return '';
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }




// ðŸ”¹ Listen for live messages
  db.ref('messages').on('value', snap => renderMessages(snap.val()));



  // ðŸ”¹ Send text message
  msgForm.addEventListener('submit', (e) => {
    e.preventDefault();
    const text = msgInput.value.trim();
    if (!text) return;
    db.ref('messages').push({
      username: currentUserId, // store ID in Firebase
      text,
      timestamp: Date.now()
    }).then(() => {
      msgInput.value = '';
    }).catch(err => alert(err.message));
  });

  
  
  // ðŸ”¹ Auto logout after 20 minutes
  setTimeout(() => {
    sessionStorage.clear();
    localStorage.clear();
    alert("Session expired. Please log in again.");
    window.location.href = "index.html";
  }, 20 * 60 * 1000);
</script>
<script>
  
  
  // Toggle GIF container
const toggleBtn = document.getElementById("toggleBtn");
const gifContainer = document.getElementById("locked");

toggleBtn.addEventListener("click", (e) => {
  e.preventDefault(); // prevent form submission
  if (gifContainer.style.display === "none") {
    gifContainer.style.display = "block";
    toggleBtn.value = "Hide GIFs";
  } else {
    gifContainer.style.display = "none";
    toggleBtn.value = "Show GIFs";
  }
});

</script>
  </div>
</body>
</html>