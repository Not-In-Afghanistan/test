<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PingPals</title>
  <link rel="stylesheet" href="./chat.css" />
  <link rel="icon" type="image/png" href="./favicon.png"/> 
</head>

<body>
 <!-- Id to name --> 
<script>
  // üîπ Map of 6-digit IDs to display names
  const idToName = {
    "596923": "Muzafar",
    "589533": "Kyle",
    "589425": "Jeffery",
    "564380": "Harshan",
    "603974": "Disani",
    "546766": "Camden",
    "596922": "Veena",
    "545208": "Braylen",
    "547025": "Jostin",
    "600437": "Blake",
    "599328": "Ethan",
    "592276": "Nitya",
    "598292": "Jacob"
    // Add more like: "123456": "YourChosenName"
    
  };
</script>

<!-- cooldown -->
<script>
  // üßë‚Äçüíª IDs with short cooldown (5 seconds)
const shortCooldownUsers = ["596923", "547025"]; 
</script>

<!-- Admin Panel Script -->
<script>
const adminUsers = ["596923"]; // Admin IDs

function createAdminPanel() {
  const currentUserId = localStorage.getItem("username") || sessionStorage.getItem("username");
  if (!currentUserId || !adminUsers.includes(currentUserId)) return;

  // Inject admin panel CSS
  const style = document.createElement("style");
  style.textContent = `
    #adminPanel {
      position: fixed;
      top: 8px;
      right: 20px;
      backdrop-filter: blur(10px);
      border: 1px solid #cccccc;
      padding: 14px 18px;
      width: 320px;
      text-align: center;
      z-index: 999;
      animation: fadeIn 0.3s ease;
    }
    #adminPanel h3 { font-size:16px; margin-bottom:10px; }
    #adminPanel button { margin-top:5px; padding:4px 8px; cursor:pointer; }
    #adminPanel input { width: 80%; margin:4px 0; padding:3px; }
    #bannedList { max-height:150px; overflow-y:auto; text-align:left; margin-top:8px; }
    @keyframes fadeIn { from{opacity:0; transform:translateY(-55%);} to{opacity:1; transform:translateY(-50%);} }
  `;
  document.head.appendChild(style);

  // Create the panel
  const panel = document.createElement("div");
  panel.id = "adminPanel";
  panel.innerHTML = `
    <h3>Admin Panel</h3>
    <button id="clearMessagesBtn">Clear All Messages</button>
    <p id="adminStatus">Logged in as admin: ${currentUserId}</p>
    <hr>
    <h4>Ban User</h4>
    <input type="text" id="banUsername" placeholder="Enter username or ID" />
    <input type="number" id="banDuration" placeholder="Minutes" min="1"/>
    <button id="banBtn">Ban User</button>
    <p id="banInfo" style="font-size:12px;color:#aaa;margin-top:4px;"></p>
    <hr>
    <h4>Currently Banned Users</h4>
    <div id="bannedList"><p>Loading...</p></div>
  `;
  document.body.appendChild(panel);

  // Clear all messages
  document.getElementById("clearMessagesBtn").addEventListener("click", () => {
    if (confirm("‚ö†Ô∏è Are you sure you want to delete ALL messages?")) {
      db.ref("messages").remove().catch(err => alert("‚ùå Error: " + err.message));
    }
  });

  // Ban user
  document.getElementById("banBtn").addEventListener("click", () => {
    const usernameOrId = document.getElementById("banUsername").value.trim();
    const durationMinutes = parseInt(document.getElementById("banDuration").value);

    if (!usernameOrId || isNaN(durationMinutes) || durationMinutes < 1) {
      alert("‚ùå Please enter a valid username/ID and duration.");
      return;
    }

    // Resolve ID if display name is given
    let userId = Object.keys(idToName).find(id => idToName[id] === usernameOrId) || usernameOrId;

    const banExpires = Date.now() + durationMinutes * 60 * 1000;
    db.ref(`bans/${userId}`).set({ expires: banExpires }).then(() => {
      const expiresDate = new Date(banExpires).toLocaleString();
      alert(`‚úÖ ${usernameOrId} is banned until ${expiresDate}`);
      document.getElementById("banInfo").textContent = `${usernameOrId} banned until ${expiresDate}`;
    }).catch(err => alert("‚ùå Error: " + err.message));
  });

  // Function to update the banned users list
  function updateBannedList() {
    const listDiv = document.getElementById("bannedList");
    db.ref("bans").once("value").then(snap => {
      const bans = snap.val() || {};
      listDiv.innerHTML = "";

      Object.keys(bans).forEach(userId => {
        const ban = bans[userId];
        if (ban.expires && ban.expires > Date.now()) {
          const displayName = idToName[userId] || userId;
          const div = document.createElement("div");
          div.style.display = "flex";
          div.style.justifyContent = "space-between";
          div.style.alignItems = "center";
          div.style.marginBottom = "4px";

          const text = document.createElement("span");
          text.textContent = `${displayName} (expires: ${new Date(ban.expires).toLocaleString()})`;

          const unbanBtn = document.createElement("button");
          unbanBtn.textContent = "Unban";
          unbanBtn.addEventListener("click", () => {
            db.ref(`bans/${userId}`).remove().then(updateBannedList);
          });

          div.appendChild(text);
          div.appendChild(unbanBtn);
          listDiv.appendChild(div);
        }
      });

      if (listDiv.innerHTML === "") listDiv.innerHTML = "<p>No active bans.</p>";
    });
  }

  // Real-time listener for bans
  db.ref("bans").on("value", updateBannedList);
  updateBannedList();
}

// Check if current user is banned on login
function checkBan() {
  const currentUserId = localStorage.getItem("username") || sessionStorage.getItem("username");
  if (!currentUserId) return;

  db.ref(`bans/${currentUserId}`).once("value").then(snap => {
    const banData = snap.val();
    if (banData && banData.expires > Date.now()) {
      const expires = new Date(banData.expires).toLocaleString();
      alert(`‚õî You have been banned until ${expires}. Refresh to see this message.`);
      window.location.href = "./index.html";
    } else if (banData) {
      db.ref(`bans/${currentUserId}`).remove(); // Remove expired ban
    }
  });
}

// Initialize
window.addEventListener("load", () => {
  if (typeof db !== "undefined") {
    createAdminPanel();
    checkBan();
  }
});

</script>

<!-- User ID to Name mapping -->
<script>
  const users = {
  "596923": { name: "Muzafar", role: "Admin" },
  "547025": { name: "Jostin", role: "PremiumOG" },
  "599328": { name: "Ethan" },
  "589533": { name: "Kyle" },
  "589425": { name: "Jeffery" },
  "564380": { name: "Harshan" },
  "603974": { name: "Disani" },
  "596922": { name: "Veena" },
  "545208": { name: "Braylen" },
  "600437": { name: "Blake" },
  "598292": { name: "Jacob" }
};

</script>

<!-- Redirect if not logged in properly -->
<script>
  // Redirect if not logged in properly
  if (sessionStorage.getItem("loginAsk") !== "true") {
    // Optional: alert before redirect
    alert("Access denied. Redirecting to login...");
    window.location.href = "./index.html";
  }
</script>


<div id="locked">
    <img src="./gifs/67-67-kid.gif">
    <img src="./gifs/67.gif">
    <img src="./gifs/anime-manga.gif">
    <img src="./gifs/chill.gif">
    <img src="./gifs/cute.gif">
    <img src="./gifs/gojo.gif">
    <img src="./gifs/goon-tuah.gif">
    <img src="./gifs/kis.gif">
    <img src="./gifs/shrek.gif">
    <img src="./gifs/what.gif">
    <!-- Right-side GIFs -->
    <img src="./gifs/rightGifs/angry.gif">
    <img src="./gifs/rightGifs/bosnov-67.gif">
    <img src="./gifs/rightGifs/emoji.gif">
    <img src="./gifs/rightGifs/enojado.gif">
    <img src="./gifs/rightGifs/oh-no-oh-my-god.gif">
    <img src="./gifs/rightGifs/patrick-bateman-smile.gif">
    <img src="./gifs/rightGifs/reallycooked.gif">
    <img src="./gifs/rightGifs/sigmasungjinwoo-mewing.gif">
    <img src="./gifs/rightGifs/solo-leveling-sololeveling.gif">
    <img src="./gifs/rightGifs/thofinn.gif">
    <img src="./gifs/rightGifs/thorfinn.gif">
    <img src="./gifs/rightGifs/twitch-twitch-emote.gif">
    <img src="./gifs/rightGifs/what-twitch.gif">
</div>
<input type="submit" id="toggleBtn" value="Hide GIFs">
  <div class="MainArea">

    <div class="Header2">&nbsp;</div>
    <div class="MainActionContainer">
       <!-- Username is taken from sessionStorage set on sign-in -->

       <div id="signedInAs" class="GroupNormalMargin"></div>

         <form id="msgForm">
          <div style="display:flex; gap:8px; align-items:center;">
             <input id="msgInput" type="text" placeholder="Type a message" style="flex:1;" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" />
             <input type="submit" value="Send" />
          </div>
         </form>

       <div id="messages" class="GroupNormalMargin">
         <p>Loading messages...</p>
       </div>
    </div>

  </div>
<!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<!-- Firebase -->
<script>
  // Firebase config (same as other pages)
  const firebaseConfig = {
    apiKey: "AIzaSyBGPFSP0e0oYqKqvJHLB5eGlX9mJ8aU09s",
    authDomain: "test-da143.firebaseapp.com",
    databaseURL: "https://test-da143-default-rtdb.firebaseio.com",
    projectId: "test-da143",
    storageBucket: "test-da143.firebasestorage.app",
    messagingSenderId: "58366480447",
    appId: "1:58366480447:web:f3dd12850f09952b49688a",
    measurementId: "G-T5HK7JTWHW"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const msgForm = document.getElementById('msgForm');
  const msgInput = document.getElementById('msgInput');
  const messagesDiv = document.getElementById('messages');
</script>
<!-- Real-time ban watcher -->
<script>
(function(){
  // Real-time ban watcher - drop into index.html and homepage.html after firebase is initialized.
  let banRef = null;
  let currentWatchedId = null;

  // Helper: get current userid from storage
  function getStoredId() {
    return localStorage.getItem('username') || sessionStorage.getItem('username') || null;
  }

  // Attach a realtime listener for the given user id
  function attachBanListener(userId) {
    if (!userId) return;
    // avoid re-attaching same ref
    if (currentWatchedId === userId && banRef) return;

    // detach previous
    detachBanListener();

    currentWatchedId = userId;
    banRef = db.ref(`bans/${userId}`);
    banRef.on('value', snap => {
      const banData = snap.val();
      if (banData && banData.expires && banData.expires > Date.now()) {
        // user is currently banned
        const expiresStr = new Date(banData.expires).toLocaleString();
        try { alert(`‚õî You are banned until ${expiresStr}.`); } catch(e) { /* ignore */ }
        // force back to index (kick)
        window.location.href = "./index.html";
      } else if (banData && banData.expires && banData.expires <= Date.now()) {
        // ban expired ‚Äî cleanup server-side record optionally
        db.ref(`bans/${userId}`).remove().catch(()=>{ /* ignore */ });
      }
      // if no banData -> no active ban
    });
  }

  // Detach listener if present
  function detachBanListener() {
    if (banRef) {
      try { banRef.off(); } catch(e) {}
      banRef = null;
    }
    currentWatchedId = null;
  }

  // Keep in sync: attach for current id, detach if none or changed
  function syncBanWatcher() {
    const id = getStoredId();
    if (!id) {
      detachBanListener();
      return;
    }
    attachBanListener(id);
  }

  // React to storage changes in other tabs
  window.addEventListener('storage', (ev) => {
    if (ev.key === 'username') syncBanWatcher();
  });

  // Also check when page becomes visible (user switched tab)
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) syncBanWatcher();
  });

  // As fallback, poll every 5s to make sure we are attached (keeps things robust)
  setInterval(syncBanWatcher, 5000);

  // Start immediately (requires db to be defined)
  if (typeof db !== 'undefined') {
    syncBanWatcher();
  } else {
    // if db isn't defined yet, wait until firebase is ready
    const readyInterval = setInterval(() => {
      if (typeof db !== 'undefined') {
        clearInterval(readyInterval);
        syncBanWatcher();
      }
    }, 200);
  }

  // Expose small helper for manual control (optional)
  window.__banWatcher = {
    attach: attachBanListener,
    detach: detachBanListener,
    sync: syncBanWatcher
  };
})();
</script>
<!-- rest of the script -->
<script>
  // Helper to get stored ID
  function getStoredId() {
    return localStorage.getItem('username') || sessionStorage.getItem('username') || null;
  }

  // Get user ID and convert to display name
  const currentUserId = getStoredId();
  if (!currentUserId) {
    alert('No username found. Please sign in.');
    window.location.href = './index.html';
  }

  const displayName = idToName[currentUserId] || currentUserId;
  const signedInEl = document.getElementById('signedInAs');
  if (signedInEl) signedInEl.textContent = 'Signed in as: ' + displayName;


// Render messages
function renderMessages(data) {
  const val = data || {};
  messagesDiv.innerHTML = '';
  const entries = Object.entries(val).sort((a, b) => a[1].timestamp - b[1].timestamp);

  if (entries.length === 0) {
    messagesDiv.innerHTML = '<p>No messages yet.</p>';
    return;
  }

  for (const [key, msg] of entries) {
    const shownName = idToName[msg.username] || msg.username;
    const userInfo = users[msg.username] || {};

    // üé® Role tag style & color
    let roleTag = "";
    switch (userInfo.role) {
      case "Admin":
        roleTag = `<span style="background:linear-gradient(90deg, red, blue); color:white; padding:2px 6px; border-radius:6px; font-size:11px; margin-right:6px;">Admin</span>`;
        break;
      case "PremiumOG":
        roleTag = `<span style="background:linear-gradient(90deg, #b026ff, #6f00ff); color:white; padding:2px 6px; border-radius:6px; font-size:11px; margin-right:6px;">PremiumOG</span>`;
        break;
      default:
        roleTag = ""; // no tag for regular users
    }

    const div = document.createElement('div');
    div.className = 'entry';

    if (msg.gifUrl) {
      div.innerHTML = `
        ${roleTag}<strong>${escapeHtml(shownName)}:</strong><br>
        <img src="${escapeHtml(msg.gifUrl)}" alt="gif" style="max-width:100%; border-radius:8px;" />
        <br><small>${new Date(msg.timestamp).toLocaleString()}</small>`;
    } else {
      div.innerHTML = `
        ${roleTag}<strong>${escapeHtml(shownName)}:</strong> ${escapeHtml(msg.text)} 
        <br><small>${new Date(msg.timestamp).toLocaleString()}</small>`;
    }

    messagesDiv.appendChild(div);
  }

  messagesDiv.scrollTop = messagesDiv.scrollHeight;
}






// üîπ Cooldown system ‚Äî now server-based (prevents refresh exploits)
const gifStatus = document.createElement("p");
gifStatus.id = "gifStatus";
gifStatus.style.color = "gray";
gifStatus.style.fontSize = "14px";
gifStatus.style.textAlign = "center";
gifStatus.style.marginTop = "10px";
gifStatus.textContent = "You can send GIFs freely.";
document.body.appendChild(gifStatus);

// Helper: Start cooldown visually
function startLocalGifCooldown(seconds) {
  let timeLeft = seconds;
  gifStatus.textContent = `You can send another GIF in ${timeLeft}s`;
  const imgs = document.querySelectorAll("#locked img");
  imgs.forEach(img => {
    img.style.filter = "grayscale(100%)";
    img.style.pointerEvents = "none";
    img.style.opacity = "0.6";
  });

  const timer = setInterval(() => {
    timeLeft--;
    if (timeLeft <= 0) {
      clearInterval(timer);
      imgs.forEach(img => {
        img.style.filter = "none";
        img.style.pointerEvents = "auto";
        img.style.opacity = "1";
      });
      gifStatus.textContent = "You can now send GIFs again!";
    } else {
      gifStatus.textContent = `You can send another GIF in ${timeLeft}s`;
    }
  }, 1000);
}

// üîπ Enable GIF clicking
function enableGifClick(container) {
  const gifs = container.querySelectorAll("img");
  gifs.forEach(img => {
    img.style.cursor = "pointer";
    img.addEventListener("click", async () => {
      const userId = localStorage.getItem("username") || sessionStorage.getItem("username");
      if (!userId) return alert("User not found.");

      const userRef = db.ref(`gifCooldowns/${userId}`);
      const snap = await userRef.once("value");
      const data = snap.val();
      const now = Date.now();
      const cooldownTime = shortCooldownUsers.includes(userId) ? 3000 : 25000; // 3s / 20s

      if (data && data.expires > now) {
        const wait = Math.ceil((data.expires - now) / 1000);
        alert(`‚è≥ Please wait ${wait}s before sending another GIF.`);
        return;
      }

      // Push GIF message
      const gifUrl = img.src;
      await db.ref("messages").push({
        username: userId,
        gifUrl,
        timestamp: now
      });

      // Set cooldown in database
      await userRef.set({ expires: now + cooldownTime });

      // Auto remove from DB after cooldown
      setTimeout(() => userRef.remove().catch(() => {}), cooldownTime);

      startLocalGifCooldown(cooldownTime / 1000);
    });
  });
}

enableGifClick(document.getElementById("locked"));

// üîπ Restore GIF cooldown after refresh
async function restoreGifCooldownOnLoad() {
  const userId = localStorage.getItem("username") || sessionStorage.getItem("username");
  if (!userId) return;

  const userRef = db.ref(`gifCooldowns/${userId}`);
  const snap = await userRef.once("value");
  const data = snap.val();
  const now = Date.now();

  if (data && data.expires > now) {
    const remaining = Math.ceil((data.expires - now) / 1000);
    startLocalGifCooldown(remaining);
  } else {
    gifStatus.textContent = "You can send GIFs freely.";
  }
}

restoreGifCooldownOnLoad();
// End of GIF cooldown system

// üîπ Escape HTML helper
  function escapeHtml(s) {
    if (!s && s !== 0) return '';
    return String(s)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }




// üîπ Listen for live messages
  db.ref('messages').on('value', snap => renderMessages(snap.val()));



  // üîπ Send text message
 msgForm.addEventListener('submit', (e) => {
  e.preventDefault();
  const text = msgInput.value.trim();

  if (!text) return;
  if (text.length > 100) {
    alert(`‚ö†Ô∏è Message too long! (${text.length}/100 characters)`);
    return;
  }

  db.ref('messages').push({
    username: currentUserId,
    text,
    timestamp: Date.now()
  }).then(() => {
    msgInput.value = '';
  }).catch(err => alert(err.message));
});


</script>
<!-- toggle GIF container -->
<script>
  
  
  // Toggle GIF container
const toggleBtn = document.getElementById("toggleBtn");
const gifContainer = document.getElementById("locked");

toggleBtn.addEventListener("click", (e) => {
  e.preventDefault(); // prevent form submission
  if (gifContainer.style.display === "none") {
    gifContainer.style.display = "block";
    toggleBtn.value = "Hide GIFs";
  } else {
    gifContainer.style.display = "none";
    toggleBtn.value = "Show GIFs";
  }
});

</script>
  </div>
</body>
</html>
