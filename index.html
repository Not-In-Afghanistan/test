<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign In</title>
  <link rel="stylesheet" type="text/css" href="./StyleSheet.css"/> 
  <link rel="icon" type="image/png" href="./favicon.png"/> 
</head>

<body>
  <div id="donate">
    <p>Hi! Im Muzafar. 
    If you will and want to support me, please consider <span class="red">subscribing!</span> 
    It would really help me a lot, since I work hard and maintain this project public and allow you guys to visit.
    It also comes with perks <a href="./donate.html">Learn More</a>. Thank you!</p>
  </div>

  <div class="MainArea">
    <div class="Header"><span>Sign In</span></div>
    <div class="GroupXLargeMargin"><img src="./newlog.png" alt="logo" id="LOGO" /></div>
    <div class="GroupLargeMargin">
      <div class="TextSizeXLarge"><span>pingpalsbymuzafar.vercel.app</span></div>
    </div>

    <div class="MainActionContainer">
      <form id="form">
        <div class="GroupXLargeMargin"><span>Type your user name and password.</span></div>
        <table class="UsernamePasswordTable">
          <tr>
            <td><span class="Label">User Name:</span></td>
            <td><input type="text" id="usernameInput" maxlength="6" required /></td>
            <td class="TextColorSecondary TextSizeSmall"><span>Example: 123456</span></td>
          </tr>
          <tr>
            <td><span class="Label">Password:</span></td>
            <td><input type="password" id="passwordInput" required /></td>
          </tr>
          <tr>
            <td colspan="2">
              <div class="RightAlign GroupXLargeMargin">
                <input type="submit" value="Sign In" class="Resizable" />
              </div>
            </td>
          </tr>
        </table>
      </form>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <!-- Main Script -->
  <script type="module">
  // Fetch Firebase config from server
  const configRes = await fetch("/api/config");
  const firebaseConfig = await configRes.json();

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const form = document.getElementById("form");

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const username = document.getElementById("usernameInput").value.trim();
    const password = document.getElementById("passwordInput").value.trim();

    if (!/^\d{6}$/.test(username)) {
      alert("User ID must be exactly 6 digits.");
      return;
    }

    try {
      // Send login request to secure backend
      const res = await fetch("/api/users", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ id: username, password })
      });

      const data = await res.json();

      if (!data.ok) {
        alert(data.error);
        return;
      }

      // ✅ Login successful
      sessionStorage.setItem("loginAsk", "true");
      sessionStorage.setItem("username", username);
      localStorage.setItem("username", username);

      // Optional: push login event to Firebase database
      db.ref("users").push({ username, timestamp: Date.now() })
        .then(() => {
          form.reset();
          window.location.href = "./homepage.html";
        })
        .catch(err => alert(err.message));

    } catch (err) {
      alert("Something went wrong: " + err.message);
    }
  });

  // --- Real-time ban watcher ---
  (function(){
    let banRef = null;
    let currentWatchedId = null;

    function getStoredId() {
      return localStorage.getItem('username') || sessionStorage.getItem('username') || null;
    }

    function attachBanListener(userId) {
      if (!userId) return;
      if (currentWatchedId === userId && banRef) return;

      detachBanListener();

      currentWatchedId = userId;
      banRef = db.ref(`bans/${userId}`);
      banRef.on('value', snap => {
        const banData = snap.val();
        if (banData && banData.expires && banData.expires > Date.now()) {
          const expiresStr = new Date(banData.expires).toLocaleString();
          try { alert(`⛔ You are banned until ${expiresStr}.`); } catch(e) {}
          window.location.href = "./index.html";
        } else if (banData && banData.expires && banData.expires <= Date.now()) {
          db.ref(`bans/${userId}`).remove().catch(()=>{});
        }
      });
    }

    function detachBanListener() {
      if (banRef) {
        try { banRef.off(); } catch(e) {}
        banRef = null;
      }
      currentWatchedId = null;
    }

    function syncBanWatcher() {
      const id = getStoredId();
      if (!id) {
        detachBanListener();
        return;
      }
      attachBanListener(id);
    }

    window.addEventListener('storage', (ev) => {
      if (ev.key === 'username') syncBanWatcher();
    });

    document.addEventListener('visibilitychange', () => {
      if (!document.hidden) syncBanWatcher();
    });

    setInterval(syncBanWatcher, 5000);

    if (typeof db !== 'undefined') {
      syncBanWatcher();
    } else {
      const readyInterval = setInterval(() => {
        if (typeof db !== 'undefined') {
          clearInterval(readyInterval);
          syncBanWatcher();
        }
      }, 200);
    }

    window.__banWatcher = {
      attach: attachBanListener,
      detach: detachBanListener,
      sync: syncBanWatcher
    };
  })();
  </script>

</body>
</html>
